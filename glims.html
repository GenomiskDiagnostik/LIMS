<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>GLIMS - Genetisk LIMS</title>
<style>
:root {
  font-family: "Segoe UI", Arial, sans-serif;
}
body {
  margin: 0;
  background: #f5f7fb;
  color: #222;
}
header {
  background: linear-gradient(135deg,#124c87,#186faf);
  color: #fff;
  padding: 1rem 2rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
header h1 {
  margin:0;
  font-size:1.8rem;
}
#statusBar {
  font-size:0.9rem;
  margin-top:0.3rem;
}
nav {
  background:#fff;
  border-bottom:1px solid #c7d2e3;
  display:flex;
  flex-wrap:wrap;
  padding:0.5rem 1rem;
  gap:0.5rem;
}
nav button {
  border:none;
  background:#e3ecf8;
  color:#124c87;
  padding:0.5rem 1rem;
  border-radius:0.5rem;
  font-size:0.95rem;
  cursor:pointer;
  transition:background 0.2s;
}
nav button.active {
  background:#124c87;
  color:#fff;
}
main {
  padding:1.5rem;
}
section[data-tab] {
  display:none;
}
section[data-tab].active {
  display:block;
}
.panel {
  background:#fff;
  border-radius:0.75rem;
  box-shadow:0 4px 14px rgba(18,76,135,0.08);
  padding:1rem 1.2rem;
  margin-bottom:1.2rem;
}
.panel h2 {
  margin-top:0;
}
.flex {
  display:flex;
  gap:1rem;
  flex-wrap:wrap;
}
.flex > * {
  flex:1 1 280px;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th, td {
  padding:0.45rem 0.6rem;
  border-bottom:1px solid #dde4f1;
  text-align:left;
  font-size:0.9rem;
}
th {
  background:#f0f4fb;
}
form label {
  display:block;
  font-size:0.8rem;
  font-weight:600;
  margin-top:0.4rem;
}
form input, form select, form textarea {
  width:100%;
  padding:0.4rem;
  border-radius:0.4rem;
  border:1px solid #c3cde0;
  font-size:0.95rem;
  background:#fff;
  color:#162941;
}
form input::placeholder,
form textarea::placeholder {
  color:#6b7d97;
}
form input:focus,
form select:focus,
form textarea:focus {
  outline:2px solid rgba(24,111,175,0.35);
  border-color:#186faf;
}
form textarea {
  min-height:80px;
  resize:vertical;
}
.btn-row {
  margin-top:0.8rem;
  display:flex;
  gap:0.6rem;
  flex-wrap:wrap;
}
button.primary {
  background:#186faf;
  color:#fff;
  border:none;
  border-radius:0.5rem;
  padding:0.5rem 0.9rem;
  cursor:pointer;
}
button.danger {
  background:#c0392b;
  color:#fff;
}
button.secondary {
  background:#d9e4f6;
  color:#124c87;
}
.badge {
  display:inline-block;
  padding:0.2rem 0.5rem;
  border-radius:0.4rem;
  background:#dce6f7;
  color:#0f4173;
  font-size:0.75rem;
}
input[type="search"] {
  border-radius:1rem;
}
pre {
  background:#101927;
  color:#e8f1ff;
  padding:0.8rem;
  border-radius:0.6rem;
  overflow:auto;
}
@media (max-width:780px) {
  header {
    flex-direction:column;
    align-items:flex-start;
    gap:0.4rem;
  }
}
</style>
</head>
<body>
<header>
  <div>
    <h1>GLIMS – Genetisk laboratorieinformationssystem</h1>
    <div id="statusBar">Initialiserer...</div>
  </div>
  <div>
    <button class="primary" id="demoDataBtn">Indlæs demo-data</button>
    <button class="secondary" id="runTestsBtn">Kør selvtest</button>
  </div>
</header>
<nav id="tabNav"></nav>
<main id="tabContent"></main>
<script>
(() => {
'use strict';
const DB_NAME = 'glims';
const DB_VER = 2;
const STORES = ['patients','samples','orders','panels','variants','qc','reports','users','audit','variant_library','responses'];
const state = {
  db: null,
  cache: new Map(),
  boundHandle: null,
  autosave: false,
  autosaveTimer: null,
  currentTab: 'dashboard',
  currentUser: {name: 'system', id: 0},
  lastStatus: ''
};
const classificationMap = {
  '1': {code:'LA6576-8', display:'Godartet'},
  '2': {code:'LA6577-6', display:'Sandsynligvis godartet'},
  '3': {code:'LA4489-6', display:'Variant af ukendt betydning (VUS)'},
  '4': {code:'LA6668-3', display:'Sandsynligvis patogen'},
  '5': {code:'LA6708-8', display:'Patogen'}
};
const tabs = [
  {id:'dashboard', label:'Overblik'},
  {id:'patients', label:'Patienter'},
  {id:'samples', label:'Prøver'},
  {id:'orders', label:'Ordinationer'},
  {id:'panels', label:'Analyser/Panels'},
  {id:'variants', label:'Varianter'},
  {id:'variant_library', label:'Variantbibliotek'},
  {id:'reports', label:'Rapporter'},
  {id:'qc', label:'Kvalitetskontrol'},
  {id:'responses', label:'Svar (MedCom)'},
  {id:'users', label:'Brugere'},
  {id:'audit', label:'Revision'},
  {id:'db', label:'Database & Backup'},
  {id:'admin', label:'Administration'},
  {id:'tests', label:'Selvtest'}
];
const schemaFields = {
  patients: ['id','mrn','name','gender','birth_date','notes','created_at','updated_at'],
  samples: ['id','patient_id','sample_type','collected_at','status','notes','created_at','updated_at'],
  panels: ['id','name','description','created_at','updated_at'],
  orders: ['id','patient_id','sample_id','panel_id','clinician','status','ordered_at','created_at','updated_at'],
  variants: ['id','order_id','gene','transcript','hgvs_c','hgvs_p','zygosity','classification','criteria','af','interpretation','created_at','updated_at'],
  qc: ['id','sample_id','metric','value','unit','notes','created_at','updated_at'],
  reports: ['id','order_id','findings','summary','status','issued_at','created_at','updated_at'],
  users: ['id','name','email','role','created_at','updated_at'],
  audit: ['id','ts','user','action','entity','entity_id','before','after','created_at','updated_at'],
  variant_library: ['id','gene','transcript','hgvs_c','hgvs_p','classification','criteria','evidence','condition','inheritance','curated_by','last_review','created_at','updated_at'],
  responses: ['id','ts','sender','patient','diagnostic_report_id','variant_count','variants','raw','created_at','updated_at']
};
function esc(str) {
  return String(str ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}
function setStatus(msg) {
  state.lastStatus = msg;
  document.getElementById('statusBar').textContent = msg;
}
function initTabs() {
  const nav = document.getElementById('tabNav');
  const main = document.getElementById('tabContent');
  nav.innerHTML = '';
  main.innerHTML = '';
  tabs.forEach(tab => {
    const btn = document.createElement('button');
    btn.textContent = tab.label;
    btn.dataset.tab = tab.id;
    btn.addEventListener('click', () => activateTab(tab.id));
    nav.appendChild(btn);
    const section = document.createElement('section');
    section.dataset.tab = tab.id;
    main.appendChild(section);
  });
}
function activateTab(id) {
  state.currentTab = id;
  document.querySelectorAll('nav button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === id);
  });
  document.querySelectorAll('section[data-tab]').forEach(sec => {
    sec.classList.toggle('active', sec.dataset.tab === id);
  });
  renderTab(id);
}
function openDb() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = event => {
      const db = event.target.result;
      const ensureStore = (name, options) => {
        if (!db.objectStoreNames.contains(name)) {
          const store = db.createObjectStore(name, options);
          return store;
        }
        return event.target.transaction.objectStore(name);
      };
      const withTimestamps = store => {
        ['created_at','updated_at'].forEach(field => {
          if (!store.indexNames.contains(field)) {
            try { store.createIndex(field, field); } catch (e) {}
          }
        });
        return store;
      };
      withTimestamps(ensureStore('patients', {keyPath:'id', autoIncrement:true}));
      const samplesStore = withTimestamps(ensureStore('samples',{keyPath:'id',autoIncrement:true}));
      if (!samplesStore.indexNames.contains('patient_id')) samplesStore.createIndex('patient_id','patient_id');
      const ordersStore = withTimestamps(ensureStore('orders',{keyPath:'id',autoIncrement:true}));
      ['patient_id','sample_id','panel_id'].forEach(idx => {
        if (!ordersStore.indexNames.contains(idx)) ordersStore.createIndex(idx, idx);
      });
      withTimestamps(ensureStore('panels',{keyPath:'id',autoIncrement:true}));
      const variantsStore = withTimestamps(ensureStore('variants',{keyPath:'id',autoIncrement:true}));
      if (!variantsStore.indexNames.contains('order_id')) variantsStore.createIndex('order_id','order_id');
      const qcStore = withTimestamps(ensureStore('qc',{keyPath:'id',autoIncrement:true}));
      if (!qcStore.indexNames.contains('sample_id')) qcStore.createIndex('sample_id','sample_id');
      const reportsStore = withTimestamps(ensureStore('reports',{keyPath:'id',autoIncrement:true}));
      if (!reportsStore.indexNames.contains('order_id')) reportsStore.createIndex('order_id','order_id');
      withTimestamps(ensureStore('users',{keyPath:'id',autoIncrement:true}));
      withTimestamps(ensureStore('audit',{keyPath:'id',autoIncrement:true}));
      withTimestamps(ensureStore('variant_library',{keyPath:'id',autoIncrement:true}));
      withTimestamps(ensureStore('responses',{keyPath:'id',autoIncrement:true}));
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
function requestToPromise(req) {
  return new Promise((resolve, reject) => {
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function loadStore(name) {
  const tx = state.db.transaction(name, 'readonly');
  const store = tx.objectStore(name);
  const req = store.getAll();
  const rows = await requestToPromise(req);
  state.cache.set(name, rows);
  return rows;
}
async function loadAllStores() {
  for (const name of STORES) {
    await loadStore(name);
  }
}
function getCached(name) {
  return state.cache.get(name) ?? [];
}
function findById(store, id) {
  return getCached(store).find(item => item.id === id);
}
async function addRecord(store, record) {
  const now = new Date().toISOString();
  record.created_at = now;
  record.updated_at = now;
  const tx = state.db.transaction(store, 'readwrite');
  const req = tx.objectStore(store).add(record);
  const id = await requestToPromise(req);
  await tx.done?.catch(() => {});
  await loadStore(store);
  await logAudit('CREATE', store, id, null, record);
  scheduleAutosave();
  return id;
}
async function updateRecord(store, record, before) {
  record.updated_at = new Date().toISOString();
  const tx = state.db.transaction(store, 'readwrite');
  tx.objectStore(store).put(record);
  await tx.done?.catch(() => {});
  await loadStore(store);
  await logAudit('UPDATE', store, record.id, before, record);
  scheduleAutosave();
}
async function deleteRecord(store, id) {
  const existing = findById(store, id);
  if (!existing) return;
  const tx = state.db.transaction(store, 'readwrite');
  tx.objectStore(store).delete(id);
  await tx.done?.catch(() => {});
  await loadStore(store);
  await logAudit('DELETE', store, id, existing, null);
  scheduleAutosave();
}
async function logAudit(action, entity, entityId, before, after) {
  const entry = {
    ts: new Date().toISOString(),
    user: state.currentUser.name,
    action,
    entity,
    entity_id: entityId ?? null,
    before: before ? JSON.stringify(before) : null,
    after: after ? JSON.stringify(after) : null
  };
  const tx = state.db.transaction('audit','readwrite');
  tx.objectStore('audit').add({...entry, created_at:new Date().toISOString(), updated_at:new Date().toISOString()});
  await tx.done?.catch(() => {});
  await loadStore('audit');
}
function scheduleAutosave() {
  if (!state.autosave || !state.boundHandle) return;
  if (state.autosaveTimer) clearTimeout(state.autosaveTimer);
  state.autosaveTimer = setTimeout(() => {
    saveBoundFile().catch(err => console.error(err));
  }, 1200);
}
async function exportData() {
  const data = {};
  for (const store of STORES) {
    data[store] = JSON.parse(JSON.stringify(getCached(store)));
  }
  return data;
}
async function saveBoundFile() {
  if (!state.boundHandle) {
    setStatus('Ingen fil tilknyttet.');
    return;
  }
  const writable = await state.boundHandle.createWritable();
  const data = await exportData();
  await writable.write(JSON.stringify(data, null, 2));
  await writable.close();
  setStatus('Autogemt kl. ' + new Date().toLocaleTimeString());
}
async function manualSave() {
  try {
    await saveBoundFile();
  } catch (err) {
    console.error(err);
    alert('Kunne ikke gemme: ' + err.message);
  }
}
async function bindDbFile() {
  try {
    const [handle] = await window.showOpenFilePicker({multiple:false, types:[{description:'GLIMS-data', accept:{'application/json':['.json']}}]});
    state.boundHandle = handle;
    setStatus('Fil tilknyttet: ' + handle.name);
    const file = await handle.getFile();
    if (file.size > 0) {
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        await importData(data, true);
      } catch (err) {
        console.error(err);
        alert('Kunne ikke læse filen: ' + err.message);
      }
    }
  } catch (err) {
    if (err && err.name !== 'AbortError') {
      console.error(err);
      alert('Filtilknytning fejlede: ' + err.message);
    }
  }
  renderDbTab();
}
async function importData(data, skipConfirm=false) {
  const proceed = skipConfirm || confirm('Dette vil overskrive eksisterende data. Fortsæt?');
  if (!proceed) return;
  const timestamp = new Date().toISOString();
  for (const store of STORES) {
    const tx = state.db.transaction(store, 'readwrite');
    const objectStore = tx.objectStore(store);
    const clearReq = objectStore.clear();
    await requestToPromise(clearReq);
    const rows = data[store] ?? [];
    for (const row of rows) {
      if (!row.created_at) row.created_at = timestamp;
      if (!row.updated_at) row.updated_at = timestamp;
      objectStore.add(row);
    }
    await tx.done?.catch(() => {});
  }
  await loadAllStores();
  setStatus('Data indlæst.');
  renderAll();
}
async function downloadBackup() {
  const data = await exportData();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  triggerDownload(url, 'glims-backup.json');
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}
function triggerDownload(url, filename) {
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
async function restoreFromFile(file) {
  const text = await file.text();
  const data = JSON.parse(text);
  await importData(data);
}
function renderAll() {
  tabs.forEach(tab => renderTab(tab.id));
}
function renderTab(id) {
  const section = document.querySelector(`section[data-tab="${id}"]`);
  if (!section) return;
  switch(id) {
    case 'dashboard': return renderDashboard(section);
    case 'patients': return renderPatients(section);
    case 'samples': return renderSamples(section);
    case 'orders': return renderOrders(section);
    case 'panels': return renderPanels(section);
    case 'variants': return renderVariants(section);
    case 'variant_library': return renderVariantLibrary(section);
    case 'reports': return renderReports(section);
    case 'qc': return renderQC(section);
    case 'responses': return renderResponses(section);
    case 'users': return renderUsers(section);
    case 'audit': return renderAudit(section);
    case 'db': return renderDbTab(section);
    case 'admin': return renderAdmin(section);
    case 'tests': return renderTestsTab(section);
    default:
      section.innerHTML = '<p>Ingen data.</p>';
  }
}
function renderDashboard(section) {
  const patients = getCached('patients').length;
  const samples = getCached('samples').length;
  const orders = getCached('orders');
  const reports = getCached('reports');
  const variants = getCached('variants');
  const reported = reports.filter(r => r.status === 'final').length;
  const analysis = orders.filter(o => ['analysis','analysing'].includes(o.status)).length;
  const seq = orders.filter(o => ['sequencing','sequence'].includes(o.status)).length;
  const recentOrders = orders.slice().sort((a,b)=> (b.updated_at||'').localeCompare(a.updated_at||'' )).slice(0,5);
  const audit = getCached('audit').slice(-5).reverse();
  section.innerHTML = `
  <div class="panel">
    <h2>KPI'er</h2>
    <div class="flex">
      <div><div class="badge">Patienter</div><h3>${patients}</h3></div>
      <div><div class="badge">Prøver</div><h3>${samples}</h3></div>
      <div><div class="badge">Ordinationer</div><h3>${orders.length}</h3></div>
      <div><div class="badge">Sekventering</div><h3>${seq}</h3></div>
      <div><div class="badge">Analyse</div><h3>${analysis}</h3></div>
      <div><div class="badge">Rapporteret</div><h3>${reported}</h3></div>
      <div><div class="badge">Varianter</div><h3>${variants.length}</h3></div>
    </div>
  </div>
  <div class="panel">
    <h2>Seneste ordrer</h2>
    <table>
      <thead><tr><th>ID</th><th>Patient</th><th>Prøve</th><th>Panel</th><th>Status</th><th>Opdateret</th></tr></thead>
      <tbody>
        ${recentOrders.map(o => `<tr><td>${o.id}</td><td>${esc(getName('patients', o.patient_id))}</td><td>${o.sample_id || ''}</td><td>${getName('panels', o.panel_id)}</td><td>${esc(o.status || '')}</td><td>${esc(o.updated_at||'')}</td></tr>`).join('') || '<tr><td colspan="6">Ingen</td></tr>'}
      </tbody>
    </table>
  </div>
  <div class="panel">
    <h2>Revision</h2>
    <table>
      <thead><tr><th>Tid</th><th>Bruger</th><th>Handling</th><th>Entitet</th><th>ID</th></tr></thead>
      <tbody>
        ${audit.map(a => `<tr><td>${esc(a.ts)}</td><td>${esc(a.user)}</td><td>${esc(a.action)}</td><td>${esc(a.entity)}</td><td>${esc(a.entity_id??'')}</td></tr>`).join('') || '<tr><td colspan="5">Ingen</td></tr>'}
      </tbody>
    </table>
  </div>`;
}
function getName(store, id) {
  if (!id) return '';
  const row = findById(store, typeof id === 'string' ? Number(id) : id);
  if (!row) return '';
  return row.name || row.mrn || `#${id}`;
}
function fillForm(form, record) {
  if (!form || !record) return;
  Array.from(form.elements).forEach(el => {
    if (!el.name) return;
    if (!(el.name in record)) {
      return;
    }
    const value = record[el.name];
    if (el.type === 'checkbox') {
      el.checked = Boolean(value);
      return;
    }
    el.value = value ?? '';
  });
}
function renderPatients(section) {
  const list = getCached('patients');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="patientSearch">Søg</label>
        <input id="patientSearch" type="search" placeholder="Navn/MRN...">
        <table id="patientsTable"><thead><tr><th>ID</th><th>MRN</th><th>Navn</th><th>Køn</th><th>Født</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Patient</h2>
        <form id="patientForm">
          <input type="hidden" name="id">
          <label>MRN<input name="mrn" required></label>
          <label>Navn<input name="name" required></label>
          <label>Køn<select name="gender"><option value="">-</option><option value="male">Mand</option><option value="female">Kvinde</option><option value="other">Andet</option></select></label>
          <label>Fødselsdato<input type="date" name="birth_date"></label>
          <label>Noter<textarea name="notes"></textarea></label>
          <div class="btn-row">
            <button type="submit" class="primary">Gem</button>
            <button type="button" id="patientClear" class="secondary">Ny</button>
            <button type="button" id="patientDelete" class="danger">Slet</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('#patientsTable tbody');
  const form = section.querySelector('#patientForm');
  const searchInput = section.querySelector('#patientSearch');
  const deleteBtn = section.querySelector('#patientDelete');
  const clearBtn = section.querySelector('#patientClear');
  const genderMap = {male:'Mand', female:'Kvinde', other:'Andet'};
  const renderRows = () => {
    const term = searchInput.value.trim().toLowerCase();
    tbody.innerHTML = list.filter(p => {
      if (!term) return true;
      const displayGender = genderMap[p.gender];
      return [p.name, p.mrn, p.gender, displayGender].some(v => (v||'').toLowerCase().includes(term));
    }).map(p => {
      const gender = genderMap[p.gender] || p.gender || '';
      return `<tr data-id="${p.id}"><td>${p.id}</td><td>${esc(p.mrn)}</td><td>${esc(p.name)}</td><td>${esc(gender)}</td><td>${esc(p.birth_date||'')}</td></tr>`;
    }).join('');
  };
  renderRows();
  searchInput.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const id = Number(tr.dataset.id);
    const patient = list.find(p => p.id === id);
    if (!patient) return;
    fillForm(form, patient);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('patients', id)};
      const updated = {...before, ...data, id};
      await updateRecord('patients', updated, before);
    } else {
      delete data.id;
      await addRecord('patients', data);
    }
    await loadStore('patients');
    renderTab('patients');
    renderDashboard(document.querySelector('section[data-tab="dashboard"]'));
  });
  deleteBtn.addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg en patient');
    if (confirm('Slet patient?')) {
      await deleteRecord('patients', id);
      form.reset();
      renderTab('patients');
      renderDashboard(document.querySelector('section[data-tab="dashboard"]'));
    }
  });
  clearBtn.addEventListener('click', () => form.reset());
}
function renderSamples(section) {
  const list = getCached('samples');
  const patients = getCached('patients');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="sampleSearch">Søg</label>
        <input id="sampleSearch" type="search" placeholder="ID/status...">
        <table><thead><tr><th>ID</th><th>Patient</th><th>Prøvetype</th><th>Status</th><th>Opsamlet</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Prøve</h2>
        <form id="sampleForm">
          <input type="hidden" name="id">
          <label>Patient<select name="patient_id" required>${patients.map(p => `<option value="${p.id}">${esc(p.name)} (${esc(p.mrn)})</option>`).join('')}</select></label>
          <label>Prøvetype<input name="sample_type" required></label>
          <label>Status<input name="status"></label>
          <label>Opsamlet<input type="datetime-local" name="collected_at"></label>
          <label>Noter<textarea name="notes"></textarea></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="sampleClear">Ny</button>
            <button class="danger" type="button" id="sampleDelete">Slet</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#sampleSearch');
  const form = section.querySelector('#sampleForm');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(s => {
      if (!term) return true;
      return [s.id, s.status, s.sample_type].some(v => (v??'').toString().toLowerCase().includes(term));
    }).map(s => `<tr data-id="${s.id}"><td>${s.id}</td><td>${esc(getName('patients', Number(s.patient_id)))}</td><td>${esc(s.sample_type)}</td><td>${esc(s.status||'')}</td><td>${esc(s.collected_at||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const sample = list.find(s => s.id === Number(tr.dataset.id));
    if (!sample) return;
    fillForm(form, sample);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    data.patient_id = Number(data.patient_id);
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('samples', id)};
      const updated = {...before, ...data, id};
      await updateRecord('samples', updated, before);
    } else {
      delete data.id;
      await addRecord('samples', data);
    }
    await loadStore('samples');
    renderTab('samples');
  });
  section.querySelector('#sampleDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg sample');
    if (confirm('Slet sample?')) {
      await deleteRecord('samples', id);
      renderTab('samples');
    }
  });
  section.querySelector('#sampleClear').addEventListener('click', () => form.reset());
}
function renderPanels(section) {
  const list = getCached('panels');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="panelSearch">Søg</label>
        <input id="panelSearch" type="search" placeholder="Navn...">
        <table><thead><tr><th>ID</th><th>Navn</th><th>Beskrivelse</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Panel</h2>
        <form id="panelForm">
          <input type="hidden" name="id">
          <label>Navn<input name="name" required></label>
          <label>Beskrivelse<textarea name="description"></textarea></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="panelClear">Ny</button>
            <button class="danger" type="button" id="panelDelete">Slet</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#panelSearch');
  const form = section.querySelector('#panelForm');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(p => !term || (p.name||'').toLowerCase().includes(term)).map(p => `<tr data-id="${p.id}"><td>${p.id}</td><td>${esc(p.name)}</td><td>${esc(p.description||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const panel = list.find(p => p.id === Number(tr.dataset.id));
    if (!panel) return;
    fillForm(form, panel);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('panels', id)};
      const updated = {...before, ...data, id};
      await updateRecord('panels', updated, before);
    } else {
      delete data.id;
      await addRecord('panels', data);
    }
    await loadStore('panels');
    renderTab('panels');
  });
  section.querySelector('#panelDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg panel');
    if (confirm('Slet panel?')) {
      await deleteRecord('panels', id);
      renderTab('panels');
    }
  });
  section.querySelector('#panelClear').addEventListener('click', () => form.reset());
}
function renderOrders(section) {
  const list = getCached('orders');
  const patients = getCached('patients');
  const samples = getCached('samples');
  const panels = getCached('panels');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="orderSearch">Søg</label>
        <input id="orderSearch" type="search" placeholder="Status/ID...">
        <table><thead><tr><th>ID</th><th>Patient</th><th>Prøve</th><th>Panel</th><th>Status</th><th>Bestilt</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Ordination</h2>
        <form id="orderForm">
          <input type="hidden" name="id">
          <label>Patient<select name="patient_id" required>${patients.map(p => `<option value="${p.id}">${esc(p.name)} (${esc(p.mrn)})</option>`).join('')}</select></label>
          <label>Prøve<select name="sample_id" required>${samples.map(s => `<option value="${s.id}">${s.id} – ${esc(getName('patients', s.patient_id))}</option>`).join('')}</select></label>
          <label>Panel<select name="panel_id"><option value="">-</option>${panels.map(p => `<option value="${p.id}">${esc(p.name)}</option>`).join('')}</select></label>
          <label>Rekvirent<input name="clinician"></label>
          <label>Status<input name="status"></label>
          <label>Bestillingstidspunkt<input type="datetime-local" name="ordered_at"></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="orderClear">Ny</button>
            <button class="danger" type="button" id="orderDelete">Slet</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#orderSearch');
  const form = section.querySelector('#orderForm');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(o => !term || [o.status,o.id].some(v => (v??'').toString().toLowerCase().includes(term))).map(o => `<tr data-id="${o.id}"><td>${o.id}</td><td>${esc(getName('patients', o.patient_id))}</td><td>${esc(o.sample_id||'')}</td><td>${esc(getName('panels', o.panel_id))}</td><td>${esc(o.status||'')}</td><td>${esc(o.ordered_at||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const order = list.find(o => o.id === Number(tr.dataset.id));
    if (!order) return;
    fillForm(form, order);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    data.patient_id = Number(data.patient_id);
    data.sample_id = Number(data.sample_id);
    data.panel_id = data.panel_id ? Number(data.panel_id) : null;
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('orders', id)};
      const updated = {...before, ...data, id};
      await updateRecord('orders', updated, before);
    } else {
      delete data.id;
      await addRecord('orders', data);
    }
    await loadStore('orders');
    renderTab('orders');
    renderDashboard(document.querySelector('section[data-tab="dashboard"]'));
  });
  section.querySelector('#orderDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg ordre');
    if (confirm('Slet ordre?')) {
      await deleteRecord('orders', id);
      renderTab('orders');
      renderDashboard(document.querySelector('section[data-tab="dashboard"]'));
    }
  });
  section.querySelector('#orderClear').addEventListener('click', () => form.reset());
}
function renderVariants(section) {
  const list = getCached('variants');
  const orders = getCached('orders');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="variantSearch">Søg</label>
        <input id="variantSearch" type="search" placeholder="Gen/HGVS...">
        <table><thead><tr><th>ID</th><th>Ordination</th><th>Gen</th><th>HGVS c.</th><th>Klasse</th><th>Kriterier</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Variant</h2>
        <form id="variantForm">
          <input type="hidden" name="id">
          <label>Ordination<select name="order_id" required>${orders.map(o => `<option value="${o.id}">${o.id} – ${esc(getName('patients', o.patient_id))}</option>`).join('')}</select></label>
          <label>Gen<input name="gene" required></label>
          <label>Transkript<input name="transcript"></label>
          <label>HGVS c.<input name="hgvs_c"></label>
          <label>HGVS p.<input name="hgvs_p"></label>
          <label>Zygositet<input name="zygosity"></label>
          <label>ACMG-klasse<select name="classification" required><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></label>
          <label>Kriterier<input name="criteria" placeholder="PM1,PP3..."></label>
          <label>Allelfrekvens<input name="af" type="number" step="0.0001"></label>
          <label>Tolkning<textarea name="interpretation"></textarea></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="variantClear">Ny</button>
            <button class="danger" type="button" id="variantDelete">Slet</button>
            <button class="secondary" type="button" id="variantToLibrary">Til bibliotek</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#variantSearch');
  const form = section.querySelector('#variantForm');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(v => !term || [v.gene,v.hgvs_c,v.hgvs_p].some(val => (val||'').toLowerCase().includes(term))).map(v => `<tr data-id="${v.id}"><td>${v.id}</td><td>${v.order_id}</td><td>${esc(v.gene)}</td><td>${esc(v.hgvs_c||'')}</td><td>${esc(v.classification||'')}</td><td>${esc(v.criteria||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const variant = list.find(v => v.id === Number(tr.dataset.id));
    if (!variant) return;
    fillForm(form, variant);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    data.order_id = Number(data.order_id);
    data.classification = String(data.classification);
    if (data.af) data.af = Number(data.af);
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('variants', id)};
      const updated = {...before, ...data, id};
      await updateRecord('variants', updated, before);
    } else {
      delete data.id;
      await addRecord('variants', data);
    }
    await loadStore('variants');
    renderTab('variants');
  });
  section.querySelector('#variantDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg variant');
    if (confirm('Slet variant?')) {
      await deleteRecord('variants', id);
      renderTab('variants');
    }
  });
  section.querySelector('#variantClear').addEventListener('click', () => form.reset());
  section.querySelector('#variantToLibrary').addEventListener('click', async () => {
    const data = Object.fromEntries(new FormData(form).entries());
    if (!data.gene) return alert('Vælg variant først');
    const libraryEntry = {
      gene: data.gene,
      transcript: data.transcript,
      hgvs_c: data.hgvs_c,
      hgvs_p: data.hgvs_p,
      classification: String(data.classification || ''),
      criteria: data.criteria,
      evidence: data.interpretation,
      condition: '',
      inheritance: '',
      curated_by: state.currentUser.name,
      last_review: new Date().toISOString().split('T')[0]
    };
    await addRecord('variant_library', libraryEntry);
    await loadStore('variant_library');
    renderTab('variant_library');
    alert('Variant tilføjet til biblioteket');
  });
}
function renderVariantLibrary(section) {
  const list = getCached('variant_library');
  section.innerHTML = `
  <div class="panel">
    <label for="libSearch">Søg</label>
    <input id="libSearch" type="search" placeholder="Gen/HGVS...">
    <table><thead><tr><th>ID</th><th>Gen</th><th>HGVS</th><th>Klasse</th><th>Kriterier</th><th>Evidens</th><th>Kurateret af</th></tr></thead><tbody></tbody></table>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#libSearch');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(v => !term || [v.gene,v.hgvs_c,v.hgvs_p].some(val => (val||'').toLowerCase().includes(term))).map(v => `<tr data-id="${v.id}"><td>${v.id}</td><td>${esc(v.gene)}</td><td>${esc(v.hgvs_c||v.hgvs_p||'')}</td><td>${esc(v.classification||'')}</td><td>${esc(v.criteria||'')}</td><td>${esc(v.evidence||'')}</td><td>${esc(v.curated_by||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('dblclick', async e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    if (confirm('Slet bibliotekspost?')) {
      await deleteRecord('variant_library', Number(tr.dataset.id));
      renderTab('variant_library');
    }
  });
}
function renderReports(section) {
  const list = getCached('reports');
  const orders = getCached('orders');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="reportSearch">Søg</label>
        <input id="reportSearch" type="search" placeholder="Status...">
        <table><thead><tr><th>ID</th><th>Ordination</th><th>Status</th><th>Udstedt</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Rapport</h2>
        <form id="reportForm">
          <input type="hidden" name="id">
          <label>Ordination<select name="order_id" required>${orders.map(o => `<option value="${o.id}">${o.id} – ${esc(getName('patients', o.patient_id))}</option>`).join('')}</select></label>
          <label>Status<select name="status"><option value="draft">Udkast</option><option value="final">Endelig</option><option value="amended">Ændret</option></select></label>
          <label>Udstedt<input type="datetime-local" name="issued_at"></label>
          <label>Fund<textarea name="findings"></textarea></label>
          <label>Resumé<textarea name="summary"></textarea></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="reportClear">Ny</button>
            <button class="danger" type="button" id="reportDelete">Slet</button>
            <button class="secondary" type="button" id="reportPreview">Udskriv/forhåndsvis</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#reportSearch');
  const form = section.querySelector('#reportForm');
  const statusMap = {draft:'Udkast', final:'Endelig', amended:'Ændret'};
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(r => {
      if (!term) return true;
      const raw = (r.status||'').toLowerCase();
      const display = (statusMap[r.status] || r.status || '').toLowerCase();
      return raw.includes(term) || display.includes(term);
    }).map(r => {
      const displayStatus = statusMap[r.status] || r.status || '';
      return `<tr data-id="${r.id}"><td>${r.id}</td><td>${r.order_id}</td><td>${esc(displayStatus)}</td><td>${esc(r.issued_at||'')}</td></tr>`;
    }).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const report = list.find(r => r.id === Number(tr.dataset.id));
    if (!report) return;
    fillForm(form, report);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    data.order_id = Number(data.order_id);
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('reports', id)};
      const updated = {...before, ...data, id};
      await updateRecord('reports', updated, before);
    } else {
      delete data.id;
      await addRecord('reports', data);
    }
    await loadStore('reports');
    renderTab('reports');
  });
  section.querySelector('#reportDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg rapport');
    if (confirm('Slet rapport?')) {
      await deleteRecord('reports', id);
      renderTab('reports');
    }
  });
  section.querySelector('#reportClear').addEventListener('click', () => form.reset());
  section.querySelector('#reportPreview').addEventListener('click', () => {
    const data = Object.fromEntries(new FormData(form).entries());
    if (!data.order_id) return alert('Vælg ordre');
    const html = buildReportHtml(Number(data.order_id), data);
    const win = window.open('', '_blank');
    if (win) {
      win.document.write('<!DOCTYPE html><html><head><title>Rapport</title><style>body{font-family:Segoe UI,Arial;margin:2rem;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:0.4rem;}th{background:#f0f0f0;}</style></head><body>' + html + '</body></html>');
      win.document.close();
    }
  });
}
function buildReportHtml(orderId, reportData) {
  const order = findById('orders', orderId);
  const patient = order ? findById('patients', Number(order.patient_id)) : null;
  const sample = order ? findById('samples', Number(order.sample_id)) : null;
  const variants = getCached('variants').filter(v => v.order_id === orderId);
  const rows = variants.map(v => `<tr><td>${esc(v.gene)}</td><td>${esc(v.hgvs_c||'')}</td><td>${esc(v.hgvs_p||'')}</td><td>${esc(v.classification||'')}</td><td>${esc(v.criteria||'')}</td><td>${esc(v.af??'')}</td><td>${esc(v.interpretation||'')}</td></tr>`).join('') || '<tr><td colspan="7">Ingen fund</td></tr>';
  return `
  <h1>Diagnostisk rapport</h1>
  <p><strong>Ordination:</strong> ${orderId}</p>
  <p><strong>Patient:</strong> ${esc(patient?.name||'')} (${esc(patient?.mrn||'')})</p>
  <p><strong>Prøve:</strong> ${esc(sample?.sample_type||'')} (${sample?.id||''})</p>
  <p><strong>Status:</strong> ${esc(reportData.status||'')}</p>
  <p><strong>Udstedt:</strong> ${esc(reportData.issued_at||'')}</p>
  <h2>Resumé</h2>
  <p>${esc(reportData.summary||'')}</p>
  <h2>Fund</h2>
  <table><thead><tr><th>Gen</th><th>HGVS c.</th><th>HGVS p.</th><th>Klasse</th><th>ACMG</th><th>AF</th><th>Tolkning</th></tr></thead><tbody>${rows}</tbody></table>
  <h2>Detaljer</h2>
  <pre>${esc(reportData.findings||'')}</pre>`;
}
function renderQC(section) {
  const list = getCached('qc');
  const samples = getCached('samples');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="qcSearch">Søg</label>
        <input id="qcSearch" type="search" placeholder="Måling...">
        <table><thead><tr><th>ID</th><th>Prøve</th><th>Måling</th><th>Værdi</th><th>Enhed</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Kvalitetsmåling</h2>
        <form id="qcForm">
          <input type="hidden" name="id">
          <label>Prøve<select name="sample_id" required>${samples.map(s => `<option value="${s.id}">${s.id} – ${esc(getName('patients', s.patient_id))}</option>`).join('')}</select></label>
          <label>Måling<input name="metric" required></label>
          <label>Værdi<input name="value" type="number" step="0.0001" required></label>
          <label>Enhed<input name="unit"></label>
          <label>Noter<textarea name="notes"></textarea></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="qcClear">Ny</button>
            <button class="danger" type="button" id="qcDelete">Slet</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#qcSearch');
  const form = section.querySelector('#qcForm');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(q => !term || [q.metric,q.unit].some(v => (v||'').toLowerCase().includes(term))).map(q => `<tr data-id="${q.id}"><td>${q.id}</td><td>${esc(q.sample_id)}</td><td>${esc(q.metric)}</td><td>${esc(q.value)}</td><td>${esc(q.unit||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const qc = list.find(q => q.id === Number(tr.dataset.id));
    if (!qc) return;
    fillForm(form, qc);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    data.sample_id = Number(data.sample_id);
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('qc', id)};
      const updated = {...before, ...data, id};
      await updateRecord('qc', updated, before);
    } else {
      delete data.id;
      await addRecord('qc', data);
    }
    await loadStore('qc');
    renderTab('qc');
  });
  section.querySelector('#qcDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg QC-post');
    if (confirm('Slet QC-post?')) {
      await deleteRecord('qc', id);
      renderTab('qc');
    }
  });
  section.querySelector('#qcClear').addEventListener('click', () => form.reset());
}
function renderResponses(section) {
  const list = getCached('responses').slice().reverse();
  section.innerHTML = `
  <div class="panel">
    <div class="btn-row">
      <label class="secondary" style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.4rem 0.8rem;border-radius:0.5rem;cursor:pointer;">Importér FHIR...
        <input type="file" id="fhirImport" accept="application/json" style="display:none;">
      </label>
    </div>
    <table><thead><tr><th>Tid</th><th>Sender</th><th>Patient</th><th>Rapport</th><th>Varianter</th></tr></thead><tbody>
      ${list.map(r => `<tr><td>${esc(r.ts)}</td><td>${esc(r.sender||'')}</td><td>${esc(r.patient||'')}</td><td>${esc(r.diagnostic_report_id||'')}</td><td>${esc(r.variant_count||0)}</td></tr>`).join('') || '<tr><td colspan="5">Ingen svar</td></tr>'}
    </tbody></table>
  </div>
  <div class="panel">
    <h2>Udgående MedCom-svar</h2>
    <label>Vælg ordre<select id="fhirOrderSelect"><option value="">Vælg...</option>${getCached('orders').map(o => `<option value="${o.id}">${o.id} – ${esc(getName('patients', o.patient_id))}</option>`).join('')}</select></label>
    <div class="btn-row">
      <button class="primary" id="generateFhir">Generér FHIR-bundle</button>
      <button class="secondary" id="previewFhir">Forhåndsvis</button>
    </div>
    <pre id="fhirPreview" style="display:none"></pre>
  </div>`;
  section.querySelector('#fhirOrderSelect').addEventListener('change', () => section.querySelector('#fhirPreview').style.display='none');
  section.querySelector('#generateFhir').addEventListener('click', () => exportFhir(section, true));
  section.querySelector('#previewFhir').addEventListener('click', () => exportFhir(section, false));
  section.querySelector('#fhirImport').addEventListener('change', async e => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const json = JSON.parse(text);
      await handleInboundFhir(json, true);
      alert('FHIR bundle importeret.');
      await loadStore('responses');
      renderTab('responses');
    } catch (err) {
      console.error(err);
      alert('Kunne ikke importere: ' + err.message);
    }
    e.target.value = '';
  });
}
async function exportFhir(section, download) {
  const select = section.querySelector('#fhirOrderSelect');
  const id = Number(select.value);
  if (!id) return alert('Vælg ordre');
  const bundle = buildFhirBundle(id);
  const json = JSON.stringify(bundle, null, 2);
  const preview = section.querySelector('#fhirPreview');
  preview.textContent = json;
  preview.style.display = 'block';
  if (download) {
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    triggerDownload(url, `${id}.json`);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }
}
function buildFhirBundle(orderId) {
  const order = findById('orders', orderId);
  if (!order) throw new Error('Ordination ikke fundet');
  const patient = findById('patients', Number(order.patient_id));
  const sample = findById('samples', Number(order.sample_id));
  const panel = order.panel_id ? findById('panels', Number(order.panel_id)) : null;
  const report = getCached('reports').find(r => r.order_id === orderId) || {status:'final', summary:'', findings:''};
  const variants = getCached('variants').filter(v => v.order_id === orderId);
  const timestamp = new Date().toISOString();
  const patientResource = {
    resourceType:'Patient',
    id:`patient-${patient?.id||order.patient_id}`,
    identifier: patient?.mrn ? [{system:'urn:oid:1.2.208.176.1.2', value:patient.mrn}] : undefined,
    name: patient?.name ? [{text:patient.name}] : undefined,
    gender: patient?.gender || undefined,
    birthDate: patient?.birth_date || undefined
  };
  const specimenResource = {
    resourceType:'Specimen',
    id:`specimen-${sample?.id||order.sample_id}`,
    status:'available',
    type: {text: sample?.sample_type || 'Genomic specimen'},
    receivedTime: sample?.collected_at || undefined,
    subject: {reference:`Patient/${patientResource.id}`}
  };
  const producerOrg = {
    resourceType:'Organization',
    id:'org-producer',
    name:'GenLab Producer'
  };
  const requesterOrg = {
    resourceType:'Organization',
    id:'org-requester',
    name: order.clinician || 'Requester'
  };
  const diagnosticReport = {
    resourceType:'DiagnosticReport',
    id:`dr-${orderId}`,
    status: report.status || 'final',
    category:[{coding:[{system:'http://terminology.hl7.org/CodeSystem/v2-0074', code:'LAB', display:'Laboratory'}]}],
    code:{coding:[{system:'http://loinc.org', code:'51969-4', display:'Genetic analysis report'}]},
    subject:{reference:`Patient/${patientResource.id}`},
    effectiveDateTime: report.issued_at || new Date().toISOString(),
    issued: report.issued_at || new Date().toISOString(),
    performer:[{reference:'Organization/org-producer'}],
    resultsInterpreter: requesterOrg.name ? [{reference:'Organization/org-requester'}] : undefined,
    conclusion: report.summary || undefined,
    presentedForm: report.findings ? [{contentType:'text/plain', data:btoa(report.findings)}] : undefined
  };
  const entries = [];
  const addEntry = resource => entries.push({fullUrl:`urn:uuid:${crypto.randomUUID?.() || Math.random().toString(36).slice(2)}`, resource});
  const messageHeader = {
    resourceType:'MessageHeader',
    id:`mh-${orderId}`,
    eventCoding:{system:'http://medcom.dk/fhir/medcom-messaging-communication-event', code:'medcom-lab-reporting', display:'MedCom Lab Report'},
    source:{name:'GLIMS'},
    destination:[{name:'Recipient'}],
    sender:{reference:'Organization/org-producer'},
    focus:[{reference:`DiagnosticReport/${diagnosticReport.id}`}] 
  };
  addEntry(messageHeader);
  addEntry(patientResource);
  addEntry(producerOrg);
  addEntry(requesterOrg);
  addEntry(specimenResource);
  addEntry(diagnosticReport);
  variants.forEach((variant, idx) => {
    const obs = {
      resourceType:'Observation',
      id:`var-${orderId}-${idx+1}`,
      status:'final',
      category:[{coding:[{system:'http://terminology.hl7.org/CodeSystem/observation-category', code:'laboratory'}]}],
      code:{coding:[{system:'http://loinc.org', code:'69548-6', display:'Genomic sequence variation interpretation'}]},
      subject:{reference:`Patient/${patientResource.id}`},
      specimen:{reference:`Specimen/${specimenResource.id}`},
      valueCodeableConcept:{text:[variant.hgvs_c, variant.hgvs_p].filter(Boolean).join(' / ') || variant.gene},
      component:[{code:{text:'Gene'}, valueCodeableConcept:{text:variant.gene}}],
      interpretation: classificationMap[String(variant.classification)] ? [{coding:[{system:'http://loinc.org', code:classificationMap[String(variant.classification)].code, display:classificationMap[String(variant.classification)].display}]}] : undefined,
      note: variant.criteria ? [{text:`ACMG: ${variant.criteria}`}]: undefined
    };
    addEntry(obs);
    diagnosticReport.result = diagnosticReport.result || [];
    diagnosticReport.result.push({reference:`Observation/${obs.id}`});
  });
  const bundle = {
    resourceType:'Bundle',
    type:'message',
    timestamp,
    entry: entries
  };
  return bundle;
}
async function handleInboundFhir(bundle, offerLibrary=false) {
  if (!bundle || bundle.resourceType !== 'Bundle') throw new Error('Ikke en FHIR Bundle');
  const entries = bundle.entry || [];
  const findResource = type => entries.map(e => e.resource).find(r => r.resourceType === type);
  const diagnosticReport = findResource('DiagnosticReport');
  const patient = findResource('Patient');
  const observations = entries.map(e => e.resource).filter(r => r.resourceType === 'Observation');
  const response = {
    ts: new Date().toISOString(),
    sender: findResource('MessageHeader')?.sender?.reference || 'ukendt',
    patient: patient?.name?.[0]?.text || patient?.id || '',
    diagnostic_report_id: diagnosticReport?.id || '',
    variant_count: observations.length,
    variants: JSON.stringify(observations.map(o => ({gene:o.component?.[0]?.valueCodeableConcept?.text, note:o.note?.[0]?.text, value:o.valueCodeableConcept?.text}))),
    raw: JSON.stringify(bundle)
  };
  await addRecord('responses', response);
  if (offerLibrary && observations.length) {
    if (confirm('Tilføj varianter til bibliotek?')) {
      for (const obs of observations) {
        const note = obs.note?.[0]?.text || '';
        await addRecord('variant_library', {
          gene: obs.component?.[0]?.valueCodeableConcept?.text || '',
          transcript: '',
          hgvs_c: obs.valueCodeableConcept?.text || '',
          hgvs_p: '',
          classification: note.includes('Pathogenic') ? '5' : '',
          criteria: note.replace('ACMG: ','') || '',
          evidence: note,
          condition: '',
          inheritance: '',
          curated_by: 'FHIR import',
          last_review: new Date().toISOString().split('T')[0]
        });
      }
      await loadStore('variant_library');
    }
  }
}
function renderUsers(section) {
  const list = getCached('users');
  section.innerHTML = `
  <div class="panel">
    <div class="flex">
      <div>
        <label for="userSearch">Søg</label>
        <input id="userSearch" type="search" placeholder="Navn/mail...">
        <table><thead><tr><th>ID</th><th>Navn</th><th>E-mail</th><th>Rolle</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h2>Bruger</h2>
        <form id="userForm">
          <input type="hidden" name="id">
          <label>Navn<input name="name" required></label>
          <label>E-mail<input type="email" name="email" required></label>
          <label>Rolle<input name="role"></label>
          <div class="btn-row">
            <button class="primary" type="submit">Gem</button>
            <button class="secondary" type="button" id="userClear">Ny</button>
            <button class="danger" type="button" id="userDelete">Slet</button>
          </div>
        </form>
      </div>
    </div>
  </div>`;
  const tbody = section.querySelector('tbody');
  const search = section.querySelector('#userSearch');
  const form = section.querySelector('#userForm');
  const renderRows = () => {
    const term = search.value.toLowerCase();
    tbody.innerHTML = list.filter(u => !term || [u.name,u.email,u.role].some(v => (v||'').toLowerCase().includes(term))).map(u => `<tr data-id="${u.id}"><td>${u.id}</td><td>${esc(u.name)}</td><td>${esc(u.email)}</td><td>${esc(u.role||'')}</td></tr>`).join('');
  };
  renderRows();
  search.addEventListener('input', renderRows);
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const user = list.find(u => u.id === Number(tr.dataset.id));
    if (!user) return;
    fillForm(form, user);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if (data.id) {
      const id = Number(data.id);
      const before = {...findById('users', id)};
      const updated = {...before, ...data, id};
      await updateRecord('users', updated, before);
    } else {
      delete data.id;
      await addRecord('users', data);
    }
    await loadStore('users');
    renderTab('users');
  });
  section.querySelector('#userDelete').addEventListener('click', async () => {
    const id = Number(form.elements.id.value);
    if (!id) return alert('Vælg bruger');
    if (confirm('Slet bruger?')) {
      await deleteRecord('users', id);
      renderTab('users');
    }
  });
  section.querySelector('#userClear').addEventListener('click', () => form.reset());
}
function renderAudit(section) {
  const list = getCached('audit').slice().reverse();
  section.innerHTML = `
  <div class="panel">
    <table><thead><tr><th>Tid</th><th>Bruger</th><th>Handling</th><th>Entitet</th><th>ID</th><th>Før</th><th>Efter</th></tr></thead><tbody>
      ${list.map(a => `<tr><td>${esc(a.ts)}</td><td>${esc(a.user)}</td><td>${esc(a.action)}</td><td>${esc(a.entity)}</td><td>${esc(a.entity_id??'')}</td><td>${esc(a.before||'')}</td><td>${esc(a.after||'')}</td></tr>`).join('') || '<tr><td colspan="7">Ingen revisionsposter</td></tr>'}
    </tbody></table>
  </div>`;
}
function renderDbTab(section) {
  section = section || document.querySelector('section[data-tab="db"]');
  const status = state.boundHandle ? `Tilknyttet fil: ${state.boundHandle.name}` : 'Ingen fil tilknyttet';
  if (!section) return;
  section.innerHTML = `
  <div class="panel">
    <h2>Filbaseret database</h2>
    <p>${esc(status)}</p>
    <div class="btn-row">
      <button class="secondary" id="bindFile">Knyt/åbn DB-fil...</button>
      <button class="secondary" id="saveNow">Gem nu</button>
      <label style="display:flex;align-items:center;gap:0.5rem;">
        <input type="checkbox" id="autosaveToggle" ${state.autosave?'checked':''}> Autogem
      </label>
    </div>
  </div>
  <div class="panel">
    <h2>Backup</h2>
    <div class="btn-row">
      <button class="secondary" id="downloadBackup">Hent backup (JSON)</button>
      <label class="secondary" style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.4rem 0.8rem;border-radius:0.5rem;cursor:pointer;">Gendan fra backup<input type="file" id="restoreFile" accept="application/json" style="display:none;"></label>
    </div>
  </div>`;
  section.querySelector('#bindFile').addEventListener('click', bindDbFile);
  section.querySelector('#saveNow').addEventListener('click', manualSave);
  section.querySelector('#autosaveToggle').addEventListener('change', e => {
    state.autosave = e.target.checked;
    setStatus('Autogemning ' + (state.autosave ? 'aktiveret' : 'deaktiveret'));
  });
  section.querySelector('#downloadBackup').addEventListener('click', downloadBackup);
  section.querySelector('#restoreFile').addEventListener('change', async e => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      await restoreFromFile(file);
      alert('Backup gendannet.');
    } catch (err) {
      console.error(err);
      alert('Kunne ikke gendanne: ' + err.message);
    }
    e.target.value = '';
  });
}
function renderAdmin(section) {
  section.innerHTML = `
  <div class="panel">
    <div class="btn-row">
      <button class="primary" id="downloadSql">Hent glims.sql</button>
      <button class="secondary" id="showSchema">Vis skema</button>
      <button class="secondary" id="downloadZip">Hent ZIP</button>
    </div>
    <textarea id="schemaText" style="width:100%;min-height:200px;margin-top:1rem;display:none;"></textarea>
  </div>`;
  section.querySelector('#downloadSql').addEventListener('click', async () => {
    const sql = await generateSqlDump();
    const blob = new Blob([sql], {type:'text/sql'});
    const url = URL.createObjectURL(blob);
    triggerDownload(url, 'glims.sql');
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });
  section.querySelector('#showSchema').addEventListener('click', async () => {
    const sql = await generateSqlDump();
    const textarea = section.querySelector('#schemaText');
    textarea.value = sql;
    textarea.style.display = 'block';
  });
  section.querySelector('#downloadZip').addEventListener('click', async () => {
    const files = await buildZipFiles();
    const zipBytes = createZip(files);
    const blob = new Blob([zipBytes], {type:'application/zip'});
    const url = URL.createObjectURL(blob);
    triggerDownload(url, 'glims.zip');
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });
}
function renderTestsTab(section) {
  section.innerHTML = `
  <div class="panel">
    <h2>Selvtest</h2>
    <table><thead><tr><th>Test</th><th>Status</th><th>Detaljer</th></tr></thead><tbody id="testsBody"></tbody></table>
  </div>`;
}
async function runTests() {
  const tbody = document.querySelector('#testsBody');
  if (!tbody) {
    activateTab('tests');
    return setTimeout(runTests, 200);
  }
  const results = [];
  try {
    const patientId = await addRecord('patients', {mrn:'TEST1', name:'Testpatient', gender:'other', birth_date:'1980-01-01', notes:''});
    const patient = findById('patients', patientId);
    results.push(['Oprettelse/udlæsning patient', patient?.name === 'Testpatient', `Navn: ${patient?.name}`]);
    const sampleId = await addRecord('samples', {patient_id:patientId, sample_type:'Blod', status:'received', collected_at:new Date().toISOString(), notes:''});
    const orderId = await addRecord('orders', {patient_id:patientId, sample_id:sampleId, panel_id:null, clinician:'Testperson', status:'analysis', ordered_at:new Date().toISOString()});
    results.push(['Oprettelse ordination med FK', !!findById('orders', orderId), `Ordination ${orderId}`]);
    const reportHtml = buildReportHtml(orderId, {status:'draft', issued_at:new Date().toISOString(), summary:'Test', findings:'Ingen'});
    results.push(['Generering af rapport HTML', reportHtml.includes('Diagnostisk rapport'), 'HTML længde ' + reportHtml.length]);
    const bundle = buildFhirBundle(orderId);
    const hasResources = ['MessageHeader','Patient','DiagnosticReport','Observation'].every(type => (bundle.entry||[]).some(e => e.resource.resourceType === type));
    results.push(['Udgående FHIR-bundle indhold', hasResources, `Ressourcer: ${(bundle.entry||[]).length}`]);
    const files = await buildZipFiles();
    const zip = createZip(files);
    const view = new DataView(zip.buffer);
    const centralDirOffset = view.getUint32(zip.length - 6, true);
    results.push(['ZIP-bytes genereret', centralDirOffset > 0, `Centraldir-offset: ${centralDirOffset}`]);
    const sql = await generateSqlDump();
    results.push(['SQL-dump indeholder variants.criteria', sql.includes('`criteria`'), 'Længde ' + sql.length]);
    results.push(['Filbinding API', 'showOpenFilePicker' in window || 'showSaveFilePicker' in window, 'Filadgang ' + (('showOpenFilePicker' in window) ? 'tilgængelig' : 'ukendt')]);
  } catch (err) {
    console.error(err);
    results.push(['Testfejl', false, err.message]);
  }
  tbody.innerHTML = results.map(([name, pass, detail]) => `<tr><td>${esc(name)}</td><td>${pass ? 'OK' : 'FEJL'}</td><td>${esc(detail||'')}</td></tr>`).join('');
  await loadAllStores();
  renderAll();
}
async function buildZipFiles() {
  const backup = JSON.stringify(await exportData(), null, 2);
  const html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
  const readme = 'GLIMS - lokalt enkeltfil-LIMS\n\nÅbn glims.html i en moderne browser.\n';
  return [
    {name:'glims.html', data:utf8Encode(html)},
    {name:'glims-backup.json', data:utf8Encode(backup)},
    {name:'README.txt', data:utf8Encode(readme)}
  ];
}
function utf8Encode(str) {
  return new TextEncoder().encode(str);
}
function crc32(buf) {
  let crc = -1;
  for (let i=0; i<buf.length; i++) {
    crc = (crc >>> 8) ^ CRC_TABLE[(crc ^ buf[i]) & 0xff];
  }
  return (crc ^ -1) >>> 0;
}
const CRC_TABLE = (() => {
  const table = new Uint32Array(256);
  for (let n=0; n<256; n++) {
    let c = n;
    for (let k=0; k<8; k++) {
      c = (c & 1) ? (0xedb88320 ^ (c >>> 1)) : (c >>> 1);
    }
    table[n] = c >>> 0;
  }
  return table;
})();
function createZip(files) {
  let total = 0;
  files.forEach(f => total += 30 + f.name.length + f.data.length);
  total += files.length * 46;
  total += 22;
  const buffer = new Uint8Array(total + 1024);
  let offset = 0;
  const central = [];
  const now = new Date();
  const dostime = ((now.getHours() << 11) | (now.getMinutes() << 5) | (now.getSeconds() / 2)) & 0xffff;
  const dosdate = (((now.getFullYear() - 1980) << 9) | ((now.getMonth()+1) << 5) | now.getDate()) & 0xffff;
  for (const file of files) {
    const nameBytes = utf8Encode(file.name);
    const crc = crc32(file.data);
    const localHeader = new DataView(buffer.buffer, offset, 30);
    localHeader.setUint32(0, 0x04034b50, true);
    localHeader.setUint16(4, 20, true);
    localHeader.setUint16(6, 0, true);
    localHeader.setUint16(8, 0, true);
    localHeader.setUint16(10, dostime, true);
    localHeader.setUint16(12, dosdate, true);
    localHeader.setUint32(14, crc, true);
    localHeader.setUint32(18, file.data.length, true);
    localHeader.setUint32(22, file.data.length, true);
    localHeader.setUint16(26, nameBytes.length, true);
    localHeader.setUint16(28, 0, true);
    offset += 30;
    buffer.set(nameBytes, offset);
    offset += nameBytes.length;
    buffer.set(file.data, offset);
    offset += file.data.length;
    central.push({nameBytes, crc, size:file.data.length, offset: offset - file.data.length - nameBytes.length - 30});
  }
  const centralStart = offset;
  for (const entry of central) {
    const view = new DataView(buffer.buffer, offset, 46);
    view.setUint32(0, 0x02014b50, true);
    view.setUint16(4, 0x031E, true);
    view.setUint16(6, 20, true);
    view.setUint16(8, 0, true);
    view.setUint16(10, 0, true);
    view.setUint16(12, dostime, true);
    view.setUint16(14, dosdate, true);
    view.setUint32(16, entry.crc, true);
    view.setUint32(20, entry.size, true);
    view.setUint32(24, entry.size, true);
    view.setUint16(28, entry.nameBytes.length, true);
    view.setUint16(30, 0, true);
    view.setUint16(32, 0, true);
    view.setUint16(34, 0, true);
    view.setUint16(36, 0, true);
    view.setUint32(38, 0, true);
    view.setUint32(42, entry.offset, true);
    offset += 46;
    buffer.set(entry.nameBytes, offset);
    offset += entry.nameBytes.length;
  }
  const centralSize = offset - centralStart;
  const view = new DataView(buffer.buffer, offset, 22);
  view.setUint32(0, 0x06054b50, true);
  view.setUint16(4, 0, true);
  view.setUint16(6, 0, true);
  view.setUint16(8, central.length, true);
  view.setUint16(10, central.length, true);
  view.setUint32(12, centralSize, true);
  view.setUint32(16, centralStart, true);
  view.setUint16(20, 0, true);
  offset += 22;
  return buffer.slice(0, offset);
}
async function generateSqlDump() {
  const createStatements = `SET NAMES utf8mb4;\nSET FOREIGN_KEY_CHECKS=0;\nCREATE TABLE IF NOT EXISTS \`patients\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`mrn\` VARCHAR(64),\n  \`name\` VARCHAR(255),\n  \`gender\` VARCHAR(32),\n  \`birth_date\` DATE,\n  \`notes\` TEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`users\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`name\` VARCHAR(255),\n  \`email\` VARCHAR(255),\n  \`role\` VARCHAR(128),\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`panels\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`name\` VARCHAR(255),\n  \`description\` TEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`samples\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`patient_id\` INT,\n  \`sample_type\` VARCHAR(128),\n  \`collected_at\` DATETIME,\n  \`status\` VARCHAR(64),\n  \`notes\` TEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME,\n  CONSTRAINT fk_samples_patient FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE ON UPDATE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`orders\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`patient_id\` INT,\n  \`sample_id\` INT,\n  \`panel_id\` INT NULL,\n  \`clinician\` VARCHAR(255),\n  \`status\` VARCHAR(64),\n  \`ordered_at\` DATETIME,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME,\n  CONSTRAINT fk_orders_patient FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE ON UPDATE CASCADE,\n  CONSTRAINT fk_orders_sample FOREIGN KEY (sample_id) REFERENCES samples(id) ON DELETE CASCADE ON UPDATE CASCADE,\n  CONSTRAINT fk_orders_panel FOREIGN KEY (panel_id) REFERENCES panels(id) ON DELETE SET NULL ON UPDATE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`reports\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`order_id\` INT,\n  \`findings\` TEXT,\n  \`summary\` TEXT,\n  \`status\` VARCHAR(32),\n  \`issued_at\` DATETIME,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME,\n  CONSTRAINT fk_reports_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE ON UPDATE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`qc_metrics\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`sample_id\` INT,\n  \`metric\` VARCHAR(128),\n  \`value\` DECIMAL(18,6),\n  \`unit\` VARCHAR(64),\n  \`notes\` TEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME,\n  CONSTRAINT fk_qc_sample FOREIGN KEY (sample_id) REFERENCES samples(id) ON DELETE CASCADE ON UPDATE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`variants\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`order_id\` INT,\n  \`gene\` VARCHAR(128),\n  \`transcript\` VARCHAR(128),\n  \`hgvs_c\` VARCHAR(255),\n  \`hgvs_p\` VARCHAR(255),\n  \`zygosity\` VARCHAR(64),\n  \`classification\` VARCHAR(8),\n  \`criteria\` VARCHAR(255),\n  \`af\` DECIMAL(18,6),\n  \`interpretation\` TEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME,\n  CONSTRAINT fk_variants_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE ON UPDATE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`variant_library\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`gene\` VARCHAR(128),\n  \`transcript\` VARCHAR(128),\n  \`hgvs_c\` VARCHAR(255),\n  \`hgvs_p\` VARCHAR(255),\n  \`classification\` VARCHAR(8),\n  \`criteria\` VARCHAR(255),\n  \`evidence\` TEXT,\n  \`condition\` VARCHAR(255),\n  \`inheritance\` VARCHAR(128),\n  \`curated_by\` VARCHAR(255),\n  \`last_review\` DATE,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`responses\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`ts\` DATETIME,\n  \`sender\` VARCHAR(255),\n  \`patient\` VARCHAR(255),\n  \`diagnostic_report_id\` VARCHAR(255),\n  \`variant_count\` INT,\n  \`variants\` TEXT,\n  \`raw\` LONGTEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nCREATE TABLE IF NOT EXISTS \`audit_log\` (\n  \`id\` INT AUTO_INCREMENT PRIMARY KEY,\n  \`ts\` DATETIME,\n  \`user\` VARCHAR(128),\n  \`action\` VARCHAR(64),\n  \`entity\` VARCHAR(64),\n  \`entity_id\` INT,\n  \`before\` LONGTEXT,\n  \`after\` LONGTEXT,\n  \`created_at\` DATETIME,\n  \`updated_at\` DATETIME\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\nSET FOREIGN_KEY_CHECKS=1;\n`;
  const rows = await exportData();
  const inserts = [];
  const mapTable = {
    patients:'patients', users:'users', samples:'samples', panels:'panels', orders:'orders', reports:'reports', qc:'qc_metrics', variants:'variants', variant_library:'variant_library', responses:'responses', audit:'audit_log'
  };
  for (const [store, table] of Object.entries(mapTable)) {
    const data = rows[store] || [];
    if (!data.length) continue;
    const fields = schemaFields[store];
    const values = data.map(row => `(${fields.map(field => sqlValue(row[field])).join(',')})`).join(',\n');
    inserts.push(`INSERT INTO \`${table}\` (${fields.map(f => `\`${f}\``).join(',')}) VALUES\n${values};`);
  }
  return createStatements + inserts.join('\n') + '\n';
}
function sqlValue(val) {
  if (val === null || val === undefined || val === '') return 'NULL';
  if (typeof val === 'number') return String(val);
  const str = String(val).replace(/'/g, "''");
  return `'${str}'`;
}
async function loadDemoData() {
  if (!confirm('Indlæse demo-data? Dette overskriver ikke eksisterende poster men tilføjer hvis tomt.')) return;
  if (!getCached('patients').length) {
    const p1 = await addRecord('patients', {mrn:'MRN001', name:'Anna Jensen', gender:'female', birth_date:'1985-03-12', notes:'Familiehistorik positiv'});
    const p2 = await addRecord('patients', {mrn:'MRN002', name:'Lars Petersen', gender:'male', birth_date:'1978-11-03', notes:''});
    const s1 = await addRecord('samples', {patient_id:p1, sample_type:'Blod', status:'sequencing', collected_at:new Date().toISOString(), notes:''});
    const s2 = await addRecord('samples', {patient_id:p2, sample_type:'Spyt', status:'analysis', collected_at:new Date().toISOString(), notes:''});
    const panel = await addRecord('panels', {name:'Onko-panel', description:'50 gener'});
    const o1 = await addRecord('orders', {patient_id:p1, sample_id:s1, panel_id:panel, clinician:'Dr. Holm', status:'analysis', ordered_at:new Date().toISOString()});
    const o2 = await addRecord('orders', {patient_id:p2, sample_id:s2, panel_id:panel, clinician:'Dr. Holm', status:'reported', ordered_at:new Date().toISOString()});
    await addRecord('variants', {order_id:o1, gene:'BRCA1', transcript:'NM_007294.3', hgvs_c:'c.5266dupC', hgvs_p:'p.Gln1756Profs', zygosity:'heterozygot', classification:'5', criteria:'PVS1,PS3,PM2,PP3', af:0.0001, interpretation:'Patogen variant med høj risiko'});
    await addRecord('qc', {sample_id:s1, metric:'Dækning', value:98.5, unit:'%', notes:''});
    await addRecord('reports', {order_id:o2, findings:'Ingen klinisk signifikante varianter', summary:'Negativ rapport', status:'final', issued_at:new Date().toISOString()});
    await addRecord('users', {name:'Admin', email:'admin@example.com', role:'Administrator'});
  } else {
    alert('Demo-data allerede til stede.');
  }
  await loadAllStores();
  renderAll();
}
function hookUi() {
  document.getElementById('demoDataBtn').addEventListener('click', loadDemoData);
  document.getElementById('runTestsBtn').addEventListener('click', () => {
    activateTab('tests');
    setTimeout(runTests, 200);
  });
}
async function init() {
  initTabs();
  try {
    state.db = await openDb();
    setStatus('Database åben');
    await loadAllStores();
    hookUi();
    renderAll();
    activateTab('dashboard');
  } catch (err) {
    console.error(err);
    setStatus('Kunne ikke åbne database: ' + err.message);
  }
}
document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
