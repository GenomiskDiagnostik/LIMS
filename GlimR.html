function parseDanishCpr(value) {
  if (!value) return null;
  const digits = value.replace(/\D/g, '');
  if (digits.length !== 10) return null;
  const day = Number(digits.slice(0, 2));
  const month = Number(digits.slice(2, 4));
  const yearTwoDigits = Number(digits.slice(4, 6));
  const sequence = digits.slice(6);
  const sequenceNumber = Number(sequence);
  if (Number.isNaN(day) || Number.isNaN(month) || Number.isNaN(yearTwoDigits) || Number.isNaN(sequenceNumber)) return null;
  const determineCentury = () => {
    if (sequenceNumber >= 0 && sequenceNumber <= 3999) {
      return yearTwoDigits <= 36 ? 2000 : 1900;
    }
    if (sequenceNumber >= 4000 && sequenceNumber <= 4999) {
      return yearTwoDigits <= 57 ? 2000 : 1800;
    }
    if (sequenceNumber >= 5000 && sequenceNumber <= 8999) {
      return 1900;
    }
    if (sequenceNumber >= 9000 && sequenceNumber <= 9999) {
      return yearTwoDigits <= 36 ? 2000 : 1900;
    }
    return null;
  };
  const century = determineCentury();
  if (century == null) return null;
  const year = century + yearTwoDigits;
  const date = new Date(year, month - 1, day);
  if (Number.isNaN(date.getTime())) return null;
  if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) return null;
  const pad = num => String(num).padStart(2, '0');
  const birthDate = `${year}-${pad(month)}-${pad(day)}`;
  const gender = Number(sequence.slice(-1)) % 2 === 0 ? 'female' : 'male';
  return {birthDate, gender};
}

function applyCprAutofill(form) {
  if (!form) return;
  const mrnInput = form.elements.patient_mrn || form.elements.mrn;
  const birthInput = form.elements.patient_birth || form.elements.birth_date;
  const genderSelect = form.elements.patient_gender || form.elements.gender;
  if (!mrnInput || (!birthInput && !genderSelect)) return;
  let lastAutofill = {birthDate: null, gender: null};
  const updateFromMrn = () => {
    const parsed = parseDanishCpr(mrnInput.value.trim());
    if (!parsed) {
      lastAutofill = {birthDate: null, gender: null};
      return;
    }
    if (birthInput && (!birthInput.value || birthInput.value === lastAutofill.birthDate)) {
      birthInput.value = parsed.birthDate;
    }
    if (genderSelect && (!genderSelect.value || genderSelect.value === lastAutofill.gender)) {
      genderSelect.value = parsed.gender;
    }
    lastAutofill = parsed;
  };
  mrnInput.addEventListener('input', updateFromMrn);
  mrnInput.addEventListener('blur', updateFromMrn);
  updateFromMrn();
}

  applyCprAutofill(form);
  applyCprAutofill(form);
