const DB_VER = 15;
const DEFAULT_VARIANT_PRETEXT = 'Du er en klinisk genetisk assistent. Beregn ACMG/AMP-klassifikation efter seneste retningslinjer inkl. SVI-opdateringer og brug kun dokumenterbare fakta. Returner kun JSON der matcher skabelonen og ingen fri tekst. Udfyld kun felter du med sikkerhed kan bestemme. "classification" skal være et tal 1-5 (1 benign, 5 patogen). "criteria" skal være en komma-adskilt liste over anvendte ACMG-koder med styrke (fx "PVS1_strong, PS3_moderate, PM2_supporting").';
const classificationSynonyms = [
  {pattern: /likely\s*benign|formodet\s*benign/i, value: '2'},
  {pattern: /benign/i, value: '1'},
  {pattern: /vus|uncertain|usikker/i, value: '3'},
  {pattern: /likely\s*pathogen(ic)?|formodet\s*patogen/i, value: '4'},
  {pattern: /pathogen(ic)?|patogen/i, value: '5'}
];

function normaliseClassificationValue(value) {
  if (value == null) return '';
  const numeric = Number(value);
  if (Number.isFinite(numeric)) {
    if (numeric >= 1 && numeric <= 5) return String(Math.round(numeric));
  }
  const text = String(value).trim();
  if (!text) return '';
  const digitMatch = text.match(/\b([1-5])\b/);
  if (digitMatch) return digitMatch[1];
  const byDisplay = Object.entries(classificationMap).find(([, meta]) => meta.display.toLowerCase() === text.toLowerCase());
  if (byDisplay) return byDisplay[0];
  const synonym = classificationSynonyms.find(entry => entry.pattern.test(text));
  return synonym ? synonym.value : '';
}

function normalizeCriteriaEntry(entry) {
  if (!entry) return '';
  if (Array.isArray(entry)) {
    return entry.map(normalizeCriteriaEntry).filter(Boolean).join(', ');
  }
  if (typeof entry === 'string' || typeof entry === 'number') {
    return String(entry).trim();
  }
  if (typeof entry === 'object') {
    const code = (entry.code || entry.id || entry.name || '').toString().trim();
    const strength = (entry.strength || entry.level || '').toString().trim();
    if (code && strength) return `${code}_${strength.replace(/\s+/g, '_').toLowerCase()}`;
    return code;
  }
  return '';
}

function formatCriteriaValue(value) {
  if (value == null) return '';
  if (Array.isArray(value)) {
    return value.map(normalizeCriteriaEntry).filter(Boolean).join(', ');
  }
  if (typeof value === 'object') {
    const entries = [];
    for (const [code, strength] of Object.entries(value)) {
      const normalised = normalizeCriteriaEntry({code, strength});
      if (normalised) entries.push(normalised);
    }
    return entries.join(', ');
  }
  return normalizeCriteriaEntry(value);
}
      const aiProviderStore = withTimestamps(ensureStore('ai_providers',{keyPath:'id',autoIncrement:true}));
      ['name','provider_type'].forEach(idx => {
        if (!aiProviderStore.indexNames.contains(idx)) {
          try { aiProviderStore.createIndex(idx, idx); } catch (e) {}
        }
      });
    'Beregn ACMG/AMP-klassifikation (1 benign – 5 patogen) efter seneste guidelines inkl. SVI-justeringer.',
    'Udfyld kriterier med ACMG-koder og styrke som komma-adskilt tekst (fx PVS1_strong, PS3_moderate, PM2_supporting).',
    } else if (formField === 'classification') {
      const normalised = normaliseClassificationValue(value);
      if (normalised) control.value = normalised;
    } else if (formField === 'criteria') {
      const formatted = formatCriteriaValue(value);
      if (formatted || currentValue.trim() === '') {
        control.value = formatted;
      }
          <p class="form-hint">Knappen udfylder varianten automatisk ud fra HGVS/position og udbyderens pretext. Resultatet tilpasses JSON-skabelonen og inkluderer ACMG/AMP-klassifikation og kriteriestyrker.</p>
