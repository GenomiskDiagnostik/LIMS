  const mrnInput = form?.elements.mrn;
  const genderSelect = form?.elements.gender;
  if (birthDateInput) {
    birthDateInput.addEventListener('input', () => {
      birthDateInput.dataset.cprAutofill = 'manual';
      updateAgeNote();
    });
  }
  if (genderSelect) {
    const markGenderManual = () => {
      genderSelect.dataset.cprAutofill = 'manual';
    };
    genderSelect.addEventListener('input', markGenderManual);
    genderSelect.addEventListener('change', markGenderManual);
  }
  const applyCprAutofill = () => {
    if (!mrnInput) return;
    const parsed = parseCprNumber(mrnInput.value);
    if (!parsed) {
      if (birthDateInput && birthDateInput.dataset.cprAutofill === 'auto') {
        birthDateInput.value = '';
        delete birthDateInput.dataset.cprAutofill;
        updateAgeNote();
      }
      if (genderSelect && genderSelect.dataset.cprAutofill === 'auto') {
        genderSelect.value = '';
        delete genderSelect.dataset.cprAutofill;
      }
      return;
    }
    if (birthDateInput && (!birthDateInput.value || birthDateInput.dataset.cprAutofill !== 'manual')) {
      birthDateInput.value = parsed.birthDate;
      birthDateInput.dataset.cprAutofill = 'auto';
      updateAgeNote();
    }
    if (genderSelect && (!genderSelect.value || genderSelect.dataset.cprAutofill !== 'manual')) {
      genderSelect.value = parsed.gender;
      genderSelect.dataset.cprAutofill = 'auto';
    }
  };
  if (mrnInput) {
    const triggerAutofill = () => applyCprAutofill();
    mrnInput.addEventListener('input', triggerAutofill);
    mrnInput.addEventListener('change', triggerAutofill);
    mrnInput.addEventListener('blur', triggerAutofill);
    applyCprAutofill();
  }
    if (birthDateInput) delete birthDateInput.dataset.cprAutofill;
    if (genderSelect) delete genderSelect.dataset.cprAutofill;
function parseCprNumber(value) {
  if (value === null || value === undefined) return null;
  const normalized = String(value).trim().replace(/\s+/g, '');
  const match = normalized.match(/^(\d{2})(\d{2})(\d{2})-?(\d{4})$/);
  if (!match) return null;
  const day = Number(match[1]);
  const month = Number(match[2]);
  const yearTwoDigits = Number(match[3]);
  const sequence = match[4];
  if (!Number.isFinite(day) || !Number.isFinite(month) || !Number.isFinite(yearTwoDigits)) return null;
  const centuryDigit = Number(sequence[0]);
  if (!Number.isFinite(centuryDigit)) return null;
  let century = null;
  if (centuryDigit >= 0 && centuryDigit <= 3) {
    century = 1900;
  } else if (centuryDigit === 4 || centuryDigit === 9) {
    century = yearTwoDigits <= 36 ? 2000 : 1900;
  } else if (centuryDigit >= 5 && centuryDigit <= 8) {
    century = yearTwoDigits <= 57 ? 2000 : 1800;
  } else {
    return null;
  }
  const year = century + yearTwoDigits;
  const birthDate = new Date(year, month - 1, day);
  if (
    Number.isNaN(birthDate.getTime()) ||
    birthDate.getFullYear() !== year ||
    birthDate.getMonth() !== month - 1 ||
    birthDate.getDate() !== day
  ) {
    return null;
  }
  const genderDigit = Number(sequence[sequence.length - 1]);
  if (!Number.isFinite(genderDigit)) return null;
  const gender = genderDigit % 2 === 0 ? 'female' : 'male';
  const isoBirth = `${String(year).padStart(4, '0')}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  return {birthDate: isoBirth, gender};
}

