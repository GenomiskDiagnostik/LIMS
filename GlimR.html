const VARIANT_LIBRARY_LOOKUP_CACHE = new Map();
  if (name === 'variant_library') {
    VARIANT_LIBRARY_LOOKUP_CACHE.clear();
  }
async function findVariantLibraryMatchByIdentifiers({gene, transcript, hgvsC, genomicPosition, rsid}) {
  const normalize = value => collapseSpaces(value || '').toLowerCase();
  const normalizedCriteria = {
    gene: normalize(gene),
    transcript: normalize(transcript),
    hgvsC: normalize(hgvsC),
    genomicPosition: normalize(genomicPosition),
    rsid: normalizeRsId(rsid)
  };
  const cacheKey = JSON.stringify(normalizedCriteria);
  if (VARIANT_LIBRARY_LOOKUP_CACHE.has(cacheKey)) {
    return VARIANT_LIBRARY_LOOKUP_CACHE.get(cacheKey);
  }
  if (!normalizedCriteria.hgvsC && !normalizedCriteria.genomicPosition && !normalizedCriteria.rsid) {
    VARIANT_LIBRARY_LOOKUP_CACHE.set(cacheKey, null);
    return null;
  }
  if (!state.db) {
    VARIANT_LIBRARY_LOOKUP_CACHE.set(cacheKey, null);
    return null;
  }
  return new Promise(resolve => {
    let settled = false;
    const finish = result => {
      if (settled) return;
      settled = true;
      const value = result || null;
      VARIANT_LIBRARY_LOOKUP_CACHE.set(cacheKey, value);
      resolve(value);
    };
    try {
      const tx = state.db.transaction('variant_library', 'readonly');
      const store = tx.objectStore('variant_library');
      const cursorRequest = store.openCursor();
      cursorRequest.onerror = () => finish(null);
      tx.onerror = () => finish(null);
      tx.oncomplete = () => finish(null);
      cursorRequest.onsuccess = event => {
        const cursor = event.target.result;
        if (!cursor) {
          finish(null);
          return;
        }
        const entry = cursor.value || {};
        const entryGene = normalize(entry.gene || entry.region);
        const entryTranscript = normalize(entry.transcript);
        const entryHgvsC = normalize(entry.hgvs_c);
        const entryGenomicPos = normalize(entry.genomic_position || entry.position || entry.genomicPosition || entry.genomicpos);
        const entryRsid = normalizeRsId(getVariantRsId(entry));
        let match = false;
        if (normalizedCriteria.hgvsC) {
          if (normalizedCriteria.gene && entryGene === normalizedCriteria.gene && entryHgvsC === normalizedCriteria.hgvsC) {
            match = true;
          } else if (normalizedCriteria.transcript && entryTranscript === normalizedCriteria.transcript && entryHgvsC === normalizedCriteria.hgvsC) {
            match = true;
          }
        }
        if (!match && normalizedCriteria.genomicPosition && entryGenomicPos === normalizedCriteria.genomicPosition) {
          match = true;
        }
        if (!match && normalizedCriteria.rsid && entryRsid === normalizedCriteria.rsid) {
          match = true;
        }
        if (match) {
          finish(entry);
          return;
        }
        cursor.continue();
      };
    } catch (err) {
      console.warn('Kunne ikke slÃ¥ variant op i biblioteket', err);
      finish(null);
    }
  });
}

    const geneField = row.querySelector('[data-field="gene"]');
    const transcriptField = row.querySelector('[data-field="transcript"]');
    const hgvsCField = row.querySelector('[data-field="hgvs_c"]');
    const genomicPositionField = row.querySelector('[data-field="genomic_position"]');
    const rsidField = row.querySelector('[data-field="rsid"]');
    const maybeAutofillFromLibrary = async () => {
      const match = await findVariantLibraryMatchByIdentifiers({
        gene: geneField?.value,
        transcript: transcriptField?.value,
        hgvsC: hgvsCField?.value,
        genomicPosition: genomicPositionField?.value,
        rsid: rsidField?.value
      });
      if (!match) return;
      const setIfEmpty = (selector, value) => {
        if (value === undefined || value === null) return;
        const el = row.querySelector(selector);
        if (!el) return;
        if ((el.value || '').trim()) return;
        setValue(selector, value);
      };
      setValue('[data-field="variant_type"]', normalizeVariantType(match.variant_type));
      setIfEmpty('[data-field="gene"]', match.gene || match.region);
      setIfEmpty('[data-field="transcript"]', match.transcript);
      setIfEmpty('[data-field="hgvs_c"]', match.hgvs_c);
      setIfEmpty('[data-field="hgvs_p"]', match.hgvs_p);
      setIfEmpty('[data-field="genomic_position"]', match.genomic_position || match.position || match.genomicPosition || match.genomicpos);
      setIfEmpty('[data-field="rsid"]', getVariantRsId(match));
      setIfEmpty('[data-field="zygosity"]', match.zygosity);
      setIfEmpty('[data-field="criteria"]', match.criteria);
      setIfEmpty('[data-field="genome_build"]', match.genome_build || match.genome || match.reference_genome);
      setIfEmpty('[data-field="chromosome"]', match.chromosome || match.chrom);
      setIfEmpty('[data-field="start"]', match.start || match.position_start || match.begin);
      setIfEmpty('[data-field="end"]', match.end || match.position_end || match.finish);
      setIfEmpty('[data-field="copy_number"]', match.copy_number || match.copynumber || match.copies);
      setIfEmpty('[data-field="sv_subtype"]', match.sv_subtype || match.structural_type || match.variant_subtype);
      setIfEmpty('[data-field="size_bp"]', match.size_bp);
      setIfEmpty('[data-field="iscn"]', match.iscn || match.cytogenetic);
      setIfEmpty('[data-field="affected_genes"]', match.affected_genes || match.genes);
      setIfEmpty('[data-field="description"]', match.description);
      const classField = row.querySelector('[data-field="classification"]');
      if (classField && match.classification != null && match.classification !== '') {
        classField.value = String(match.classification);
      }
      const interpretationField = row.querySelector('[data-field="interpretation"]');
      if (interpretationField && !interpretationField.value.trim()) {
        interpretationField.value = match.evidence || match.interpretation || '';
      }
      const annotationsField = row.querySelector('[data-field="annotations"]');
      if (annotationsField && !annotationsField.value.trim()) {
        annotationsField.value = match.annotations || match.annotation_summary || '';
      }
      updateVariantTypeFields();
      setMessage('Felter udfyldt automatisk fra Variantbiblioteket.', 'success');
    };
    [geneField, transcriptField, hgvsCField, genomicPositionField, rsidField].forEach(field => {
      ['change', 'blur', 'input'].forEach(eventName => {
        field?.addEventListener(eventName, maybeAutofillFromLibrary);
      });
    });
    if (genomicPositionField) {
      setTooltip(genomicPositionField, tooltipCatalog.forms.variantForm.genomic_position);
    }
    if (rsidField) {
      setTooltip(rsidField, tooltipCatalog.forms.variantForm.rsid);
    }
